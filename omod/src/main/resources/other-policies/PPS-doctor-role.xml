<PolicySet xmlns="urn:oasis:names:tc:xacml:3.0:core:schema:wd-17"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:md="http://dot.rural.ac.uk/rbac/test/data/data_schema.xsd"
	xsi:schemaLocation="urn:oasis:names:tc:xacml:3.0:core:schema:wd-­17  xacml-­core-­v3-­schema-­wd-­17.xsd"
	PolicySetId="PPS:doctor:role" Version="1.0"
	PolicyCombiningAlgId="urn:oasis:names:tc:xacml:3.0:policy-combining-algorithm:permit-overrides">

	<Description> PolicySet with permission for the doctor role !
	</Description>
	<Target>
	
	</Target>

	<Policy PolicyId="Permissions:specifically:for:the:doctor:role"
		Version="1.0"
		RuleCombiningAlgId="urn:oasis:names:tc:xacml:3.0:rule-combining-algorithm:permit-overrides">
		<Description> Policy with permission for the doctor role !  </Description>
	  	<Target>     
  	  	</Target>
  	  	
		<!--  CHECK THE REQUEST IS GET PATIENT OR NOT  -->
		<VariableDefinition VariableId="getpatients">
			<Apply FunctionId="urn:oasis:names:tc:xacml:1.0:function:and">
				<Apply FunctionId ="urn:oasis:names:tc:xacml:1.0:function:string-equal">
					<AttributeValue DataType="http://www.w3.org/2001/XMLSchema#string">get</AttributeValue>
					<Apply FunctionId="urn:oasis:names:tc:xacml:1.0:function:string-one-and-only">
						<AttributeDesignator MustBePresent="false"
							Category="luca:tmac:permission-category:permission" AttributeId="luca:tmac:permission-category:permission:action"
							DataType="http://www.w3.org/2001/XMLSchema#string" />
					</Apply>
				</Apply>
				<Apply FunctionId ="urn:oasis:names:tc:xacml:1.0:function:string-equal">
					<AttributeValue DataType="http://www.w3.org/2001/XMLSchema#string">patients</AttributeValue>
					<Apply FunctionId="urn:oasis:names:tc:xacml:1.0:function:string-one-and-only">
						<AttributeDesignator MustBePresent="false"
							Category="luca:tmac:permission-category:permission" AttributeId="luca:tmac:permission-category:permission:resource_type"
							DataType="http://www.w3.org/2001/XMLSchema#string" />
					</Apply>
				</Apply>
			</Apply>
		</VariableDefinition>
		
		<!--  CHECK WHETHER THE WANTED PATIENT IN ASSIGNED PATIENT OR NOT  -->
		<VariableDefinition VariableId="checkasignedpatients">
			<Apply FunctionId="urn:oasis:names:tc:xacml:1.0:function:string-at-least-one-member-of">
				<AttributeDesignator MustBePresent="false"
					Category="luca:tmac:subject-category:subject" AttributeId="luca:tmac:subject-category:subject:wanted_patient"
					DataType="http://www.w3.org/2001/XMLSchema#string" />
				<AttributeDesignator MustBePresent="false"
					Category="luca:tmac:subject-category:subject" AttributeId="luca:tmac:subject-category:subject:assigned_patient"
					DataType="http://www.w3.org/2001/XMLSchema#string" />
			</Apply>
		</VariableDefinition>
		
		<!--   CHECK WHETHER USER HAVE ENOUGH BUDGET OR NOT   -->
		<VariableDefinition VariableId="checkbudget">
			<Apply FunctionId="urn:oasis:names:tc:xacml:1.0:function:double-greater-than-or-equal">
				<Apply FunctionId="urn:oasis:names:tc:xacml:1.0:function:double-one-and-only">
					<AttributeDesignator MustBePresent="false"
						Category="luca:tmac:subject-category:subject" AttributeId="luca:tmac:subject-category:subject:budget"
						DataType="http://www.w3.org/2001/XMLSchema#double" />
				</Apply>
				<Apply FunctionId="urn:oasis:names:tc:xacml:1.0:function:double-one-and-only">
					<AttributeDesignator MustBePresent="false"
						Category="luca:tmac:risk-category:risk" AttributeId="luca:tmac:risk-category:risk:needed-budget"
						DataType="http://www.w3.org/2001/XMLSchema#double" />
				</Apply>
			</Apply>
		</VariableDefinition>
		
		<!--   CHECK WHETHER TIME IN RANGE OR NOT  -->
		<VariableDefinition VariableId="checktimerange">
			<Apply FunctionId="urn:oasis:names:tc:xacml:2.0:function:time-in-range">
				<Apply FunctionId="urn:oasis:names:tc:xacml:1.0:function:time-one-and-only">
					<AttributeDesignator MustBePresent="false"
						Category="urn:oasis:names:tc:xacml:3.0:attribute-category:environment" AttributeId="urn:oasis:names:tc:xacml:1.0:environment:current-time"
						DataType="http://www.w3.org/2001/XMLSchema#time" />
				</Apply>
					<AttributeValue DataType="http://www.w3.org/2001/XMLSchema#time">09:00:00</AttributeValue>
					<AttributeValue DataType="http://www.w3.org/2001/XMLSchema#time">10:00:00</AttributeValue>
			</Apply>
		</VariableDefinition>
		
		
		<Rule RuleId="Permission:to:visit:patient:without:worktime" Effect="Permit">
			<Description> Permission to visit an assigned patient for doctor 5 (ID), if it's not the work time, need to check the budget and perform obligation </Description>
			<Target>
				<AnyOf>
					<AllOf>
						<Match MatchId="urn:oasis:names:tc:xacml:1.0:function:string-equal">
							<AttributeValue DataType="http://www.w3.org/2001/XMLSchema#string">5</AttributeValue>
							<AttributeDesignator MustBePresent="false"
								Category="luca:tmac:subject-category:subject" AttributeId="luca:tmac:subject-category:subject:id"
								DataType="http://www.w3.org/2001/XMLSchema#string" />
						</Match>
					</AllOf>
				</AnyOf>
			</Target>
			
			<Condition>
				<Apply FunctionId="urn:oasis:names:tc:xacml:1.0:function:and">
					<VariableReference VariableId="getpatients"/>
					<VariableReference VariableId="checkasignedpatients"/>
					<VariableReference VariableId="checkbudget"/>
					<Apply FunctionId="urn:oasis:names:tc:xacml:1.0:function:not">
						<VariableReference VariableId="checktimerange"/>
					</Apply>
				</Apply>
				
			</Condition>
			
			<ObligationExpressions>
				<ObligationExpression ObligationId="system:decrease:budget"
					FulfillOn="Permit">
					<AttributeAssignmentExpression
						AttributeId="budgetDecreaseMessage">
						<AttributeValue DataType="http://www.w3.org/2001/XMLSchema#string">decrease budget until user obligation performed.
						</AttributeValue>
					</AttributeAssignmentExpression>
					<AttributeAssignmentExpression
						AttributeId="needed-budget">
						<Apply FunctionId="urn:oasis:names:tc:xacml:1.0:function:double-one-and-only">
						<AttributeDesignator MustBePresent="false" 
							Category="luca:tmac:risk-category:risk" AttributeId="luca:tmac:risk-category:risk:needed-budget"
							DataType="http://www.w3.org/2001/XMLSchema#double"/>
						</Apply>
					</AttributeAssignmentExpression>
					<AttributeAssignmentExpression
						AttributeId="budget">
						<Apply FunctionId="urn:oasis:names:tc:xacml:1.0:function:double-one-and-only">
						<AttributeDesignator MustBePresent="false"
							Category="luca:tmac:subject-category:subject" AttributeId="luca:tmac:subject-category:subject:budget"
							DataType="http://www.w3.org/2001/XMLSchema#double" />
					</Apply>
					</AttributeAssignmentExpression>
				</ObligationExpression>
				
				<ObligationExpression ObligationId="user:send:email"
					FulfillOn="Permit">
					<AttributeAssignmentExpression
						AttributeId="message">
						<AttributeValue DataType="http://www.w3.org/2001/XMLSchema#string">Send an email to Anitacao1@gmail.com, 
						the format in the beginning of the content should be : [yourUserId;yourObligationUUID], 
						the duration is : 24 hours.
						</AttributeValue>
					</AttributeAssignmentExpression>
					<AttributeAssignmentExpression
						AttributeId="duration">
						<AttributeValue
							DataType="http://www.w3.org/TR/2002/WD-xquery-operators-20020816#dayTimeDuration">P1DT15S</AttributeValue>
					</AttributeAssignmentExpression>
					<AttributeAssignmentExpression
						AttributeId="id">
						<AttributeValue
							DataType="http://www.w3.org/2001/XMLSchema#string">5</AttributeValue>
					</AttributeAssignmentExpression>
					
				</ObligationExpression> 
			</ObligationExpressions>
		</Rule>
		
		<Rule RuleId="Permission:to:visit:patient:in:worktime" Effect="Permit">
			<Description> Permission to visit an assigned patient for doctor 5 (ID), if it's in the work time, no need to check budget or perform obligation </Description>
			<Target>
				<AnyOf>
					<AllOf>
						<Match MatchId="urn:oasis:names:tc:xacml:1.0:function:string-equal">
							<AttributeValue DataType="http://www.w3.org/2001/XMLSchema#string">5</AttributeValue>
							<AttributeDesignator MustBePresent="false"
								Category="luca:tmac:subject-category:subject" AttributeId="luca:tmac:subject-category:subject:id"
								DataType="http://www.w3.org/2001/XMLSchema#string" />
						</Match>
					</AllOf>
				</AnyOf>
			</Target>
			<Condition>
				<Apply FunctionId="urn:oasis:names:tc:xacml:1.0:function:and">
					<VariableReference VariableId="getpatients"/>
					<VariableReference VariableId="checkasignedpatients"/>
					<VariableReference VariableId="checktimerange"/>
				</Apply>
			</Condition>
		</Rule>
		
		
		<!-- Permission for doctor anita to create patients -->
		<Rule RuleId="Permission:to:create:patient" Effect="Permit">
			<Description> Permission to get identifier types for doctor 3(ID)</Description>
			<Target>
				<AnyOf>
					<AllOf>
						<Match MatchId="urn:oasis:names:tc:xacml:1.0:function:string-equal">
							<AttributeValue DataType="http://www.w3.org/2001/XMLSchema#string">3</AttributeValue>
							<AttributeDesignator MustBePresent="false"
								Category="luca:tmac:subject-category:subject" AttributeId="luca:tmac:subject-category:subject:id"
								DataType="http://www.w3.org/2001/XMLSchema#string" />
						</Match>
						<Match MatchId="urn:oasis:names:tc:xacml:1.0:function:string-equal">
							<AttributeValue DataType="http://www.w3.org/2001/XMLSchema#string">get</AttributeValue>
							<AttributeDesignator MustBePresent="false"
								Category="luca:tmac:permission-category:permission" AttributeId="luca:tmac:permission-category:permission:action"
								DataType="http://www.w3.org/2001/XMLSchema#string" />
						</Match>
						<Match MatchId="urn:oasis:names:tc:xacml:1.0:function:string-equal">
							<AttributeValue DataType="http://www.w3.org/2001/XMLSchema#string">identifier types</AttributeValue>
							<AttributeDesignator MustBePresent="false"
								Category="luca:tmac:permission-category:permission"
								AttributeId="luca:tmac:permission-category:permission:resource_type"
								DataType="http://www.w3.org/2001/XMLSchema#string" />
						</Match>
					</AllOf>
				</AnyOf>
			</Target>
			
		</Rule>
		
		<!-- Permission for doctor anita to save the created patients -->
		<Rule RuleId="Permission:to:create:patient:sava" Effect="Permit">
			<Description> Permission to visit every patient at any time for doctor 3(ID) </Description>
			<Target>
				<AnyOf>
					<AllOf>
						<Match MatchId="urn:oasis:names:tc:xacml:1.0:function:string-equal">
							<AttributeValue DataType="http://www.w3.org/2001/XMLSchema#string">3</AttributeValue>
							<AttributeDesignator MustBePresent="false"
								Category="luca:tmac:subject-category:subject" AttributeId="luca:tmac:subject-category:subject:id"
								DataType="http://www.w3.org/2001/XMLSchema#string" />
						</Match>
						<Match MatchId="urn:oasis:names:tc:xacml:1.0:function:string-equal">
							<AttributeValue DataType="http://www.w3.org/2001/XMLSchema#string">patients</AttributeValue>
							<AttributeDesignator MustBePresent="false"
								Category="luca:tmac:permission-category:permission"
								AttributeId="luca:tmac:permission-category:permission:resource_type"
								DataType="http://www.w3.org/2001/XMLSchema#string" />
						</Match>
						
					</AllOf>
				</AnyOf>
			</Target>
			
			<Condition>
				<Apply
					FunctionId="urn:oasis:names:tc:xacml:1.0:function:string-at-least-one-member-of">
					<AttributeDesignator MustBePresent="false"
								Category="luca:tmac:permission-category:permission" AttributeId="luca:tmac:permission-category:permission:action"
								DataType="http://www.w3.org/2001/XMLSchema#string" />
					<Apply FunctionId="urn:oasis:names:tc:xacml:1.0:function:string-bag">
           				 <AttributeValue DataType="http://www.w3.org/2001/XMLSchema#string">get</AttributeValue>
           				 <AttributeValue DataType="http://www.w3.org/2001/XMLSchema#string">add</AttributeValue>
           				 <AttributeValue DataType="http://www.w3.org/2001/XMLSchema#string">edit</AttributeValue>
       			    </Apply>
				</Apply>
			</Condition>
			
		</Rule>
	</Policy>
</PolicySet>